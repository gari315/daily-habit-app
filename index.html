<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ãƒ©ãƒ³ãƒ€ãƒ ã‚¿ã‚¹ã‚¯ç®¡ç†</title>
  <style>
    :root {
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --text-main: #e0e0e0;
      --text-dim: #a0a0a0;
      --accent: #3d5afe;
      --success: #00c853;
      --warning: #ffd600;
      --danger: #ff5252;
      --border: #333;
      --info: #00b8d4;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      position: relative;
    }

    header h1 {
      font-size: 2rem;
      letter-spacing: 4px;
      margin: 0 0 10px 0;
      color: var(--accent);
    }

    .subtitle {
      font-size: 0.85rem;
      color: var(--text-dim);
      letter-spacing: 2px;
    }

    .header-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .header-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .header-btn.test-btn {
      background: var(--info);
    }

    .header-btn:hover {
      filter: brightness(1.2);
      transform: scale(1.05);
    }

    .stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .stat-item {
      background: var(--card-bg);
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--accent);
    }

    .stat-item.test-countdown {
      border-color: var(--info);
    }

    .stat-item.test-countdown .stat-value {
      color: var(--info);
    }

    .task-display {
      margin-bottom: 30px;
    }

    .card {
      background: var(--card-bg);
      width: 100%;
      min-height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      font-size: 1.3rem;
      font-weight: bold;
      text-align: center;
      border: 1px solid var(--border);
      transition: transform 0.3s ease;
      margin-bottom: 20px;
      word-break: break-word;
    }

    .main-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .draw-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .btn {
      padding: 16px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-primary {
      background-color: var(--accent);
      color: white;
    }

    .btn-secondary {
      background-color: var(--info);
      color: white;
    }

    .btn-success {
      background-color: transparent;
      color: var(--success);
      border: 2px solid var(--success);
    }

    .btn-warning {
      background-color: transparent;
      color: var(--warning);
      border: 2px solid var(--warning);
    }

    .btn-danger {
      background-color: transparent;
      color: var(--danger);
      border: 2px solid var(--danger);
    }

    .btn:hover {
      filter: brightness(1.2);
      transform: scale(1.02);
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-success:hover {
      background-color: var(--success);
      color: #000;
    }

    .btn-warning:hover {
      background-color: var(--warning);
      color: #000;
    }

    .btn-danger:hover {
      background-color: var(--danger);
      color: #fff;
    }

    .lists-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .list-section {
      display: flex;
      flex-direction: column;
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .list-section h2 {
      font-size: 0.9rem;
      color: var(--text-dim);
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
      margin: 0;
      flex-grow: 1;
    }

    .add-task-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      margin-left: 10px;
    }

    .scroll-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 300px;
      overflow-y: auto;
    }

    .scroll-list li {
      background: var(--card-bg);
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 8px;
      font-size: 0.85rem;
      border: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .task-info {
      flex-grow: 1;
      word-break: break-word;
    }

    .task-buttons {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }

    .scroll-list li button {
      background: var(--accent);
      border: none;
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.7rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .scroll-list li button.delete-btn {
      background: var(--danger);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 12px;
      border: 1px solid var(--border);
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-content h3 {
      margin-top: 0;
      color: var(--accent);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .today-badge {
      background: var(--success);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: normal;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-dim);
      font-size: 0.9rem;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      background: var(--bg-color);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-main);
      font-size: 1rem;
    }

    .form-group input[type="date"] {
      color-scheme: dark;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
    }

    .modal-buttons button {
      flex: 1;
    }

    .habit-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .habit-item {
      background: var(--bg-color);
      padding: 14px 16px;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s ease;
    }

    .habit-item:hover {
      border-color: var(--accent);
    }

    .habit-item.completed {
      opacity: 0.6;
      background: var(--card-bg);
    }

    .habit-checkbox {
      width: 24px;
      height: 24px;
      min-width: 24px;
      cursor: pointer;
      accent-color: var(--success);
    }

    .habit-text {
      flex-grow: 1;
      font-size: 0.95rem;
    }

    .habit-item.completed .habit-text {
      text-decoration: line-through;
      color: var(--text-dim);
    }

    .habit-progress {
      margin-top: 20px;
      padding: 15px;
      background: var(--bg-color);
      border-radius: 8px;
      border: 1px solid var(--border);
      text-align: center;
    }

    .habit-progress-text {
      font-size: 0.85rem;
      color: var(--text-dim);
      margin-bottom: 8px;
    }

    .habit-progress-bar {
      width: 100%;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
    }

    .habit-progress-fill {
      height: 100%;
      background: var(--success);
      transition: width 0.3s ease;
    }

    .test-item {
      background: var(--bg-color);
      padding: 14px 16px;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .test-item-info {
      flex-grow: 1;
    }

    .test-item-title {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .test-item-date {
      font-size: 0.8rem;
      color: var(--text-dim);
    }

    .test-item button {
      background: var(--danger);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .section-divider {
      margin: 25px 0;
      border-bottom: 1px solid var(--border);
    }

    @media (max-width: 600px) {
      .container {
        padding: 15px;
      }
      
      header h1 {
        font-size: 1.5rem;
      }

      .header-buttons {
        flex-direction: column;
        width: 100%;
      }

      .header-btn {
        width: 100%;
      }

      .card {
        min-height: 150px;
        font-size: 1.1rem;
        padding: 20px;
      }

      .lists-container {
        grid-template-columns: 1fr;
      }

      .draw-buttons {
        grid-template-columns: 1fr;
      }

      .stats {
        gap: 10px;
      }

      .stat-item {
        padding: 8px 16px;
      }

      .stat-value {
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ãƒ©ãƒ³ãƒ€ãƒ ã‚¿ã‚¹ã‚¯</h1>
      <p class="subtitle">ä¸€ã¤ã®ã“ã¨ã«é›†ä¸­ã™ã‚‹</p>
      <div class="header-buttons">
        <button class="header-btn" id="habitBtn">ğŸ“… ä»Šæ—¥ã®ç¿’æ…£</button>
        <button class="header-btn test-btn" id="testBtn">ğŸ“ ãƒ†ã‚¹ãƒˆç®¡ç†</button>
      </div>
    </header>

    <div class="stats">
      <div class="stat-item test-countdown">
        <div class="stat-label">å®šæœŸãƒ†ã‚¹ãƒˆã¾ã§</div>
        <div class="stat-value" id="testCountdown">--</div>
      </div>
      <div class="stat-item" style="cursor: pointer;" id="taskCountItem">
        <div class="stat-label">ã‚¿ã‚¹ã‚¯å</div>
        <div class="stat-value" id="taskCount">0</div>
      </div>
      <div class="stat-item" style="cursor: pointer;" id="actionCountItem">
        <div class="stat-label">ä»Šã™ãè¡Œå‹•</div>
        <div class="stat-value" id="actionCount">0</div>
      </div>
    </div>

    <section class="task-display">
      <div id="currentTask" class="card">æº–å‚™ã¯ã„ã„ã§ã™ã‹?</div>
      <div class="main-buttons">
        <div class="draw-buttons">
          <button id="drawTaskBtn" class="btn btn-primary">ã‚¿ã‚¹ã‚¯ã‚’å¼•ã</button>
          <button id="drawActionBtn" class="btn btn-secondary">ä»Šã™ãã§ãã‚‹ã“ã¨</button>
        </div>
        <div class="action-buttons">
          <button id="execBtn" class="btn btn-success">å®Ÿè¡Œå®Œäº†</button>
          <button id="skipBtn" class="btn btn-warning">ã‚¹ã‚­ãƒƒãƒ—</button>
        </div>
      </div>
    </section>

    <div class="lists-container">
      <section class="list-section">
        <div class="list-header">
          <h2>ã‚¿ã‚¹ã‚¯å</h2>
          <button class="add-task-btn" id="addTaskBtn">+ è¿½åŠ </button>
        </div>
        <ul id="taskList" class="scroll-list"></ul>
      </section>
      
      <section class="list-section">
        <div class="list-header">
          <h2>ä»Šã™ãã§ãã‚‹ã“ã¨</h2>
          <button class="add-task-btn" id="addActionBtn">+ è¿½åŠ </button>
        </div>
        <ul id="actionList" class="scroll-list"></ul>
      </section>
    </div>
  </div>

  <!-- ã‚¿ã‚¹ã‚¯è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="taskModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle">ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </h3>
      <div class="form-group">
        <label for="taskInput">å†…å®¹</label>
        <input type="text" id="taskInput" placeholder="ä¾‹: æ•°å­¦ã®å®¿é¡Œã‚’ã™ã‚‹">
      </div>
      <div class="modal-buttons">
        <button class="btn btn-success" id="saveTaskBtn">ä¿å­˜</button>
        <button class="btn btn-danger" id="cancelTaskBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- æ•°å€¤ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="countModal" class="modal">
    <div class="modal-content">
      <h3 id="countModalTitle">æ®‹ã‚Šã‚¿ã‚¹ã‚¯æ•°ã‚’ç·¨é›†</h3>
      <div class="form-group">
        <label for="countInput">æ®‹ã‚Šæ•°</label>
        <input type="number" id="countInput" min="0" placeholder="0">
      </div>
      <div class="modal-buttons">
        <button class="btn btn-success" id="saveCountBtn">ä¿å­˜</button>
        <button class="btn btn-danger" id="cancelCountBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- ç¿’æ…£ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="habitModal" class="modal">
    <div class="modal-content">
      <h3>
        <span id="habitDayName">ä»Šæ—¥ã®ç¿’æ…£</span>
        <span class="today-badge" id="todayDate"></span>
      </h3>
      <div class="habit-progress">
        <div class="habit-progress-text" id="habitProgressText">0 / 0 å®Œäº†</div>
        <div class="habit-progress-bar">
          <div class="habit-progress-fill" id="habitProgressFill" style="width: 0%"></div>
        </div>
      </div>
      <ul id="habitList" class="habit-list"></ul>
      <div class="modal-buttons">
        <button class="btn btn-primary" id="closeHabitBtn">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ãƒ†ã‚¹ãƒˆç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="testModal" class="modal">
    <div class="modal-content">
      <h3>ãƒ†ã‚¹ãƒˆç®¡ç†</h3>
      
      <div class="form-group">
        <label for="testDateInput">å®šæœŸãƒ†ã‚¹ãƒˆæ—¥</label>
        <input type="date" id="testDateInput">
      </div>
      <button class="btn btn-success" id="saveTestDateBtn" style="width: 100%; margin-bottom: 20px;">ä¿å­˜</button>

      <div class="section-divider"></div>

      <h3>æå‡ºç‰©</h3>
      <div class="form-group">
        <label for="submissionInput">æå‡ºç‰©å</label>
        <input type="text" id="submissionInput" placeholder="ä¾‹: æ•°å­¦ãƒ¯ãƒ¼ã‚¯P20-30">
      </div>
      <button class="btn btn-success" id="addSubmissionBtn" style="width: 100%; margin-bottom: 15px;">è¿½åŠ </button>
      <ul id="submissionList" class="habit-list"></ul>

      <div class="section-divider"></div>

      <h3>å°ãƒ†ã‚¹ãƒˆï¼ˆå˜å…ƒãƒ†ã‚¹ãƒˆï¼‰</h3>
      <div class="form-group">
        <label for="quizNameInput">ãƒ†ã‚¹ãƒˆå</label>
        <input type="text" id="quizNameInput" placeholder="ä¾‹: è‹±å˜èªãƒ†ã‚¹ãƒˆ">
      </div>
      <div class="form-group">
        <label for="quizDateInput">å®Ÿæ–½æ—¥</label>
        <input type="date" id="quizDateInput">
      </div>
      <button class="btn btn-success" id="addQuizBtn" style="width: 100%; margin-bottom: 15px;">è¿½åŠ </button>
      <div id="quizListContainer"></div>

      <div class="modal-buttons" style="margin-top: 20px;">
        <button class="btn btn-primary" id="closeTestBtn">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
    console.log("ã‚¹ã‚¯ãƒªãƒ—ãƒˆé–‹å§‹");

    // ç¿’æ…£ãƒ‡ãƒ¼ã‚¿å®šç¾©
    const HABITS = [
      "ãƒã‚¹å¾€è·¯(Leap)",
      "ãƒã‚¹å¾©è·¯(Leap)",
      "æœãƒ†ã‚¹ãƒˆç¢ºèª(ãƒã‚¹)",
      "æœãƒ†ã‚¹ãƒˆå‹‰å¼·",
      "Vintageãƒãƒ¼ãƒˆ",
      "Vintageã®ç¯„å›²ç†è§£"
    ];

    const DAY_HABITS = {
      0: [3],
      1: [2, 3],
      2: [2, 4],
      3: [0, 1, 3],
      4: [2, 3],
      5: [2, 4],
      6: [4, 5]
    };

    const DAY_NAMES = ["æ—¥æ›œæ—¥", "æœˆæ›œæ—¥", "ç«æ›œæ—¥", "æ°´æ›œæ—¥", "æœ¨æ›œæ—¥", "é‡‘æ›œæ—¥", "åœŸæ›œæ—¥"];

    // ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
    let tasks = [];
    let actions = [];
    let currentItem = null;
    let currentType = null;
    let editingIndex = null;
    let editingType = null;
    let habitCompletions = {};
    let testDate = null;
    let submissions = [];
    let quizzes = [];
    let completedTasks = 0;
    let completedActions = 0;
    let editingCountType = null;

    // DOMè¦ç´ 
    const currentTaskDiv = document.getElementById("currentTask");
    const taskList = document.getElementById("taskList");
    const actionList = document.getElementById("actionList");
    const taskCountEl = document.getElementById("taskCount");
    const actionCountEl = document.getElementById("actionCount");
    const testCountdownEl = document.getElementById("testCountdown");
    const taskModal = document.getElementById("taskModal");
    const habitModal = document.getElementById("habitModal");
    const testModal = document.getElementById("testModal");
    const countModal = document.getElementById("countModal");
    const modalTitle = document.getElementById("modalTitle");
    const taskInput = document.getElementById("taskInput");
    const countInput = document.getElementById("countInput");
    const countModalTitle = document.getElementById("countModalTitle");

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById("drawTaskBtn").addEventListener("click", function() {
      drawItem('task');
    });
    
    document.getElementById("drawActionBtn").addEventListener("click", function() {
      drawItem('action');
    });
    
    document.getElementById("execBtn").addEventListener("click", executeItem);
    document.getElementById("skipBtn").addEventListener("click", skipItem);
    
    document.getElementById("addTaskBtn").addEventListener("click", function() {
      openAddModal('task');
    });
    
    document.getElementById("addActionBtn").addEventListener("click", function() {
      openAddModal('action');
    });
    
    document.getElementById("saveTaskBtn").addEventListener("click", saveItem);
    document.getElementById("cancelTaskBtn").addEventListener("click", closeTaskModal);
    document.getElementById("habitBtn").addEventListener("click", openHabitModal);
    document.getElementById("closeHabitBtn").addEventListener("click", closeHabitModal);
    document.getElementById("testBtn").addEventListener("click", openTestModal);
    document.getElementById("closeTestBtn").addEventListener("click", closeTestModal);
    document.getElementById("saveTestDateBtn").addEventListener("click", saveTestDate);
    document.getElementById("addSubmissionBtn").addEventListener("click", addSubmission);
    document.getElementById("addQuizBtn").addEventListener("click", addQuiz);
    
    document.getElementById("taskCountItem").addEventListener("click", function() {
      openCountModal('task');
    });
    
    document.getElementById("actionCountItem").addEventListener("click", function() {
      openCountModal('action');
    });
    
    document.getElementById("saveCountBtn").addEventListener("click", saveCount);
    document.getElementById("cancelCountBtn").addEventListener("click", closeCountModal);

    // åˆæœŸåŒ–
    function init() {
      console.log("åˆæœŸåŒ–é–‹å§‹");
      loadData();
      renderLists();
      updateStats();
      updateTestCountdown();
      checkNewDay();
      console.log("åˆæœŸåŒ–å®Œäº†");
    }

    function checkNewDay() {
      const today = new Date().toDateString();
      const lastDate = localStorage.getItem("lastHabitDate");
      
      if (lastDate !== today) {
        habitCompletions = {};
        localStorage.setItem("lastHabitDate", today);
        saveData();
      }
    }

    function saveData() {
      const data = {
        tasks: tasks,
        actions: actions,
        habitCompletions: habitCompletions,
        testDate: testDate,
        submissions: submissions,
        quizzes: quizzes,
        completedTasks: completedTasks,
        completedActions: completedActions
      };
      localStorage.setItem("taskManagerData", JSON.stringify(data));
      console.log("ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†", data);
    }

    function loadData() {
      const saved = localStorage.getItem("taskManagerData");
      if (saved) {
        const data = JSON.parse(saved);
        tasks = data.tasks || [];
        actions = data.actions || [];
        habitCompletions = data.habitCompletions || {};
        testDate = data.testDate || null;
        submissions = data.submissions || [];
        quizzes = data.quizzes || [];
        completedTasks = data.completedTasks || 0;
        completedActions = data.completedActions || 0;
      } else {
        tasks = [
          { text: "å›½èª", pending: 0 },
          { text: "æ•°å­¦", pending: 0 },
          { text: "è‹±èª", pending: 0 },
          { text: "åŒ–å­¦", pending: 0 },
          { text: "æ­´å²", pending: 0 },
          { text: "åœ°ç†", pending: 0 },
          { text: "æƒé™¤", pending: 0 }
        ];
        actions = [
          { text: "å¤æ–‡å˜èª", pending: 0 },
          { text: "ä½“ç³»æ¼¢æ–‡", pending: 0 },
          { text: "æ•°å­¦æ•™ç§‘æ›¸ç¢ºèª", pending: 0 },
          { text: "Vintageãƒãƒ¼ãƒˆ", pending: 0 },
          { text: "Leap", pending: 0 },
          { text: "åŒ–å­¦ã‚»ãƒŸãƒŠãƒ¼ç¢ºèª", pending: 0 },
          { text: "NewCompus", pending: 0 },
          { text: "æ­´å²ãƒãƒ¼ãƒˆ", pending: 0 },
          { text: "æœºã‚’ãã‚Œã„ã«ã™ã‚‹", pending: 0 }
        ];
      }
      console.log("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†", { tasks, actions });
    }

    function updateStats() {
      taskCountEl.textContent = tasks.length + completedTasks;
      actionCountEl.textContent = actions.length + completedActions;
    }

    function updateTestCountdown() {
      if (!testDate) {
        testCountdownEl.textContent = "--";
        return;
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const test = new Date(testDate);
      test.setHours(0, 0, 0, 0);
      
      const diffTime = test - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      if (diffDays < 0) {
        testCountdownEl.textContent = "çµ‚äº†";
      } else if (diffDays === 0) {
        testCountdownEl.textContent = "ä»Šæ—¥";
      } else {
        testCountdownEl.textContent = `${diffDays}æ—¥`;
      }
    }

    function renderLists() {
      console.log("ãƒªã‚¹ãƒˆæç”»é–‹å§‹");
      
      // ã‚¿ã‚¹ã‚¯ä¸€è¦§
      taskList.innerHTML = "";
      for (let i = 0; i < tasks.length; i++) {
        const t = tasks[i];
        const li = document.createElement("li");
        
        const info = document.createElement("div");
        info.className = "task-info";
        info.textContent = t.text;
        
        const buttons = document.createElement("div");
        buttons.className = "task-buttons";
        
        const editBtn = document.createElement("button");
        editBtn.textContent = "ç·¨é›†";
        editBtn.setAttribute("data-type", "task");
        editBtn.setAttribute("data-index", i);
        editBtn.addEventListener("click", handleEdit);
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.textContent = "å‰Šé™¤";
        deleteBtn.setAttribute("data-type", "task");
        deleteBtn.setAttribute("data-index", i);
        deleteBtn.addEventListener("click", handleDelete);
        
        buttons.appendChild(editBtn);
        buttons.appendChild(deleteBtn);
        
        li.appendChild(info);
        li.appendChild(buttons);
        taskList.appendChild(li);
      }

      // ä»Šã™ãã§ãã‚‹ã“ã¨ä¸€è¦§
      actionList.innerHTML = "";
      for (let i = 0; i < actions.length; i++) {
        const a = actions[i];
        const li = document.createElement("li");
        
        const info = document.createElement("div");
        info.className = "task-info";
        info.textContent = a.text;
        
        const buttons = document.createElement("div");
        buttons.className = "task-buttons";
        
        const editBtn = document.createElement("button");
        editBtn.textContent = "ç·¨é›†";
        editBtn.setAttribute("data-type", "action");
        editBtn.setAttribute("data-index", i);
        editBtn.addEventListener("click", handleEdit);
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.textContent = "å‰Šé™¤";
        deleteBtn.setAttribute("data-type", "action");
        deleteBtn.setAttribute("data-index", i);
        deleteBtn.addEventListener("click", handleDelete);
        
        buttons.appendChild(editBtn);
        buttons.appendChild(deleteBtn);
        
        li.appendChild(info);
        li.appendChild(buttons);
        actionList.appendChild(li);
      }

      updateStats();
      console.log("ãƒªã‚¹ãƒˆæç”»å®Œäº†");
    }

    function handleEdit(e) {
      const type = e.target.getAttribute("data-type");
      const index = parseInt(e.target.getAttribute("data-index"));
      console.log("ç·¨é›†ã‚¯ãƒªãƒƒã‚¯", type, index);
      openEditModal(type, index);
    }

    function handleDelete(e) {
      const type = e.target.getAttribute("data-type");
      const index = parseInt(e.target.getAttribute("data-index"));
      console.log("å‰Šé™¤ã‚¯ãƒªãƒƒã‚¯", type, index);
      deleteItem(type, index);
    }

    function deleteItem(type, index) {
      console.log("å‰Šé™¤å®Ÿè¡Œ", type, index);
      
      if (!confirm("ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        console.log("å‰Šé™¤ã‚­ãƒ£ãƒ³ã‚»ãƒ«");
        return;
      }
      
      if (type === 'task') {
        console.log("å‰Šé™¤å‰ã®tasks", tasks.length);
        tasks.splice(index, 1);
        console.log("å‰Šé™¤å¾Œã®tasks", tasks.length);
      } else {
        console.log("å‰Šé™¤å‰ã®actions", actions.length);
        actions.splice(index, 1);
        console.log("å‰Šé™¤å¾Œã®actions", actions.length);
      }
      
      if (currentItem) {
        currentItem = null;
        currentType = null;
        currentTaskDiv.textContent = "å‰Šé™¤ã•ã‚Œã¾ã—ãŸ";
      }
      
      saveData();
      renderLists();
      console.log("å‰Šé™¤å‡¦ç†å®Œäº†");
    }

    function drawItem(type) {
      const list = type === 'task' ? tasks : actions;
      
      if (list.length === 0) {
        currentTaskDiv.textContent = type === 'task' ? "ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“" : "è¡Œå‹•ãŒã‚ã‚Šã¾ã›ã‚“";
        return;
      }

      const weights = list.map(t => Math.pow(2, t.pending));
      const totalWeight = weights.reduce((a, b) => a + b, 0);
      let random = Math.random() * totalWeight;
      
      for (let i = 0; i < list.length; i++) {
        random -= weights[i];
        if (random <= 0) {
          currentItem = list[i];
          currentType = type;
          break;
        }
      }

      currentTaskDiv.textContent = currentItem.text;
    }

    function executeItem() {
      if (!currentItem || !currentType) return;
      
      if (currentType === 'task') {
        tasks = tasks.filter(t => t !== currentItem);
        completedTasks++;
      } else {
        actions = actions.filter(a => a !== currentItem);
        completedActions++;
      }
      
      currentItem = null;
      currentType = null;
      currentTaskDiv.textContent = "å®Œäº†ã—ã¾ã—ãŸï¼æ¬¡ã‚’å¼•ã„ã¦ãã ã•ã„";
      
      saveData();
      renderLists();
    }

    function openCountModal(type) {
      editingCountType = type;
      if (type === 'task') {
        countModalTitle.textContent = "ã‚¿ã‚¹ã‚¯åã®æ•°ã‚’ç·¨é›†";
        countInput.value = tasks.length + completedTasks;
      } else {
        countModalTitle.textContent = "ä»Šã™ãè¡Œå‹•ã®æ•°ã‚’ç·¨é›†";
        countInput.value = actions.length + completedActions;
      }
      countModal.classList.add("active");
      countInput.focus();
      countInput.select();
    }

    function closeCountModal() {
      countModal.classList.remove("active");
      editingCountType = null;
    }

    function saveCount() {
      const newCount = parseInt(countInput.value) || 0;
      
      if (editingCountType === 'task') {
        const currentTotal = tasks.length + completedTasks;
        const diff = newCount - currentTotal;
        
        if (diff > 0) {
          completedTasks += diff;
        } else if (diff < 0) {
          const toReduce = Math.abs(diff);
          if (completedTasks >= toReduce) {
            completedTasks -= toReduce;
          } else {
            completedTasks = 0;
          }
        }
      } else {
        const currentTotal = actions.length + completedActions;
        const diff = newCount - currentTotal;
        
        if (diff > 0) {
          completedActions += diff;
        } else if (diff < 0) {
          const toReduce = Math.abs(diff);
          if (completedActions >= toReduce) {
            completedActions -= toReduce;
          } else {
            completedActions = 0;
          }
        }
      }
      
      saveData();
      updateStats();
      closeCountModal();
    }

    function skipItem() {
      if (!currentItem || !currentType) return;
      
      currentTaskDiv.textContent = "ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚æ¬¡ã‚’å¼•ã„ã¦ãã ã•ã„";
      
      currentItem = null;
      currentType = null;
    }

    function openAddModal(type) {
      editingIndex = null;
      editingType = type;
      modalTitle.textContent = type === 'task' ? "ã‚¿ã‚¹ã‚¯åã‚’è¿½åŠ " : "ä»Šã™ãã§ãã‚‹ã“ã¨ã‚’è¿½åŠ ";
      taskInput.value = "";
      taskModal.classList.add("active");
      taskInput.focus();
    }

    function openEditModal(type, index) {
      editingIndex = index;
      editingType = type;
      modalTitle.textContent = type === 'task' ? "ã‚¿ã‚¹ã‚¯åã‚’ç·¨é›†" : "ä»Šã™ãã§ãã‚‹ã“ã¨ã‚’ç·¨é›†";
      taskInput.value = type === 'task' ? tasks[index].text : actions[index].text;
      taskModal.classList.add("active");
      taskInput.focus();
    }

    function closeTaskModal() {
      taskModal.classList.remove("active");
      taskInput.value = "";
      editingIndex = null;
      editingType = null;
    }

    function saveItem() {
      const text = taskInput.value.trim();
      
      if (!text) {
        alert("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      if (editingIndex !== null) {
        if (editingType === 'task') {
          tasks[editingIndex].text = text;
        } else {
          actions[editingIndex].text = text;
        }
      } else {
        if (editingType === 'task') {
          tasks.push({ text: text, pending: 0 });
        } else {
          actions.push({ text: text, pending: 0 });
        }
      }

      saveData();
      renderLists();
      closeTaskModal();
    }

    function openHabitModal() {
      const today = new Date();
      const dayOfWeek = today.getDay();
      const todayHabits = DAY_HABITS[dayOfWeek] || [];
      
      const month = today.getMonth() + 1;
      const date = today.getDate();
      document.getElementById("todayDate").textContent = `${month}/${date}`;
      document.getElementById("habitDayName").textContent = `${DAY_NAMES[dayOfWeek]}ã®ç¿’æ…£`;
      
      const habitList = document.getElementById("habitList");
      habitList.innerHTML = "";
      
      if (todayHabits.length === 0) {
        const li = document.createElement("li");
        li.className = "habit-item";
        li.style.justifyContent = "center";
        li.style.color = "var(--text-dim)";
        li.textContent = "ä»Šæ—¥ã®ç¿’æ…£ã¯ã‚ã‚Šã¾ã›ã‚“";
        habitList.appendChild(li);
        
        document.getElementById("habitProgressText").textContent = "0 / 0 å®Œäº†";
        document.getElementById("habitProgressFill").style.width = "0%";
      } else {
        let completedHabits = 0;
        
        todayHabits.forEach(habitIndex => {
          const habitText = HABITS[habitIndex];
          const isCompleted = habitCompletions[habitIndex] || false;
          
          if (isCompleted) completedHabits++;
          
          const li = document.createElement("li");
          li.className = "habit-item";
          if (isCompleted) li.classList.add("completed");
          
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.className = "habit-checkbox";
          checkbox.checked = isCompleted;
          checkbox.setAttribute("data-habit-index", habitIndex);
          checkbox.addEventListener("change", toggleHabit);
          
          const text = document.createElement("span");
          text.className = "habit-text";
          text.textContent = habitText;
          
          li.appendChild(checkbox);
          li.appendChild(text);
          habitList.appendChild(li);
        });
        
        const progress = Math.round((completedHabits / todayHabits.length) * 100);
        document.getElementById("habitProgressText").textContent = `${completedHabits} / ${todayHabits.length} å®Œäº†`;
        document.getElementById("habitProgressFill").style.width = `${progress}%`;
      }
      
      habitModal.classList.add("active");
    }

    function toggleHabit(e) {
      const habitIndex = parseInt(e.target.getAttribute("data-habit-index"));
      habitCompletions[habitIndex] = !habitCompletions[habitIndex];
      saveData();
      
      const today = new Date();
      const dayOfWeek = today.getDay();
      const todayHabits = DAY_HABITS[dayOfWeek] || [];
      
      let completedHabits = 0;
      todayHabits.forEach(index => {
        if (habitCompletions[index]) completedHabits++;
      });
      
      const progress = Math.round((completedHabits / todayHabits.length) * 100);
      document.getElementById("habitProgressText").textContent = `${completedHabits} / ${todayHabits.length} å®Œäº†`;
      document.getElementById("habitProgressFill").style.width = `${progress}%`;
      
      if (e.target.checked) {
        e.target.parentElement.classList.add("completed");
      } else {
        e.target.parentElement.classList.remove("completed");
      }
    }

    function closeHabitModal() {
      habitModal.classList.remove("active");
    }

    function openTestModal() {
      if (testDate) {
        document.getElementById("testDateInput").value = testDate;
      }
      renderSubmissions();
      renderQuizzes();
      testModal.classList.add("active");
    }

    function closeTestModal() {
      testModal.classList.remove("active");
    }

    function saveTestDate() {
      testDate = document.getElementById("testDateInput").value;
      saveData();
      updateTestCountdown();
      alert("å®šæœŸãƒ†ã‚¹ãƒˆæ—¥ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    }

    function addSubmission() {
      const text = document.getElementById("submissionInput").value.trim();
      
      if (!text) {
        alert("æå‡ºç‰©åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      submissions.push({ text: text, completed: false });
      document.getElementById("submissionInput").value = "";
      saveData();
      renderSubmissions();
    }

    function renderSubmissions() {
      const submissionList = document.getElementById("submissionList");
      submissionList.innerHTML = "";
      
      if (submissions.length === 0) {
        const li = document.createElement("li");
        li.className = "habit-item";
        li.style.justifyContent = "center";
        li.style.color = "var(--text-dim)";
        li.textContent = "æå‡ºç‰©ã¯ã‚ã‚Šã¾ã›ã‚“";
        submissionList.appendChild(li);
        return;
      }

      for (let i = 0; i < submissions.length; i++) {
        const sub = submissions[i];
        const li = document.createElement("li");
        li.className = "habit-item";
        if (sub.completed) li.classList.add("completed");
        
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "habit-checkbox";
        checkbox.checked = sub.completed;
        checkbox.addEventListener("change", function() {
          submissions[i].completed = !submissions[i].completed;
          saveData();
          renderSubmissions();
        });
        
        const text = document.createElement("span");
        text.className = "habit-text";
        text.textContent = sub.text;
        
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "å‰Šé™¤";
        deleteBtn.style.background = "var(--danger)";
        deleteBtn.style.marginLeft = "auto";
        deleteBtn.addEventListener("click", function() {
          submissions.splice(i, 1);
          saveData();
          renderSubmissions();
        });
        
        li.appendChild(checkbox);
        li.appendChild(text);
        li.appendChild(deleteBtn);
        submissionList.appendChild(li);
      }
    }

    function addQuiz() {
      const name = document.getElementById("quizNameInput").value.trim();
      const date = document.getElementById("quizDateInput").value;
      
      if (!name || !date) {
        alert("ãƒ†ã‚¹ãƒˆåã¨å®Ÿæ–½æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      quizzes.push({ name: name, date: date });
      quizzes.sort((a, b) => new Date(a.date) - new Date(b.date));
      
      document.getElementById("quizNameInput").value = "";
      document.getElementById("quizDateInput").value = "";
      saveData();
      renderQuizzes();
    }

    function renderQuizzes() {
      const quizListContainer = document.getElementById("quizListContainer");
      quizListContainer.innerHTML = "";
      
      if (quizzes.length === 0) {
        const div = document.createElement("div");
        div.className = "test-item";
        div.style.justifyContent = "center";
        div.style.color = "var(--text-dim)";
        div.textContent = "å°ãƒ†ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“";
        quizListContainer.appendChild(div);
        return;
      }

      for (let i = 0; i < quizzes.length; i++) {
        const quiz = quizzes[i];
        const div = document.createElement("div");
        div.className = "test-item";
        
        const info = document.createElement("div");
        info.className = "test-item-info";
        
        const title = document.createElement("div");
        title.className = "test-item-title";
        title.textContent = quiz.name;
        
        const dateText = document.createElement("div");
        dateText.className = "test-item-date";
        const quizDate = new Date(quiz.date);
        dateText.textContent = `${quizDate.getMonth() + 1}/${quizDate.getDate()}`;
        
        info.appendChild(title);
        info.appendChild(dateText);
        
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "å‰Šé™¤";
        deleteBtn.addEventListener("click", function() {
          quizzes.splice(i, 1);
          saveData();
          renderQuizzes();
        });
        
        div.appendChild(info);
        div.appendChild(deleteBtn);
        quizListContainer.appendChild(div);
      }
    }

    taskInput.addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        saveItem();
      }
    });

    document.getElementById("submissionInput").addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        addSubmission();
      }
    });

    taskModal.addEventListener("click", function(e) {
      if (e.target === taskModal) {
        closeTaskModal();
      }
    });

    habitModal.addEventListener("click", function(e) {
      if (e.target === habitModal) {
        closeHabitModal();
      }
    });

    testModal.addEventListener("click", function(e) {
      if (e.target === testModal) {
        closeTestModal();
      }
    });

    countModal.addEventListener("click", function(e) {
      if (e.target === countModal) {
        closeCountModal();
      }
    });

    countInput.addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        saveCount();
      }
    });

    init();
  </script>
</body>
</html>
