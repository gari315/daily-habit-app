<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å­¦ç¿’ç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
  <style>
    :root {
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --text-main: #e0e0e0;
      --text-dim: #a0a0a0;
      --accent: #3d5afe;
      --success: #00c853;
      --warning: #ffd600;
      --danger: #ff5252;
      --border: #333;
      --info: #00b8d4;
      --purple: #7c4dff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
    }

    header h1 {
      font-size: 2.5rem;
      letter-spacing: 4px;
      margin: 0 0 10px 0;
      color: var(--accent);
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-dim);
      letter-spacing: 2px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 25px;
      margin-bottom: 30px;
    }

    .section-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 25px;
      border: 2px solid var(--border);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .section-card:hover {
      border-color: var(--accent);
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(61, 90, 254, 0.2);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border);
    }

    .section-icon {
      font-size: 1.8rem;
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: bold;
      margin: 0;
    }

    .section-content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* ä»Šæ—¥ã®ç¿’æ…£ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .habit-section {
      border-color: var(--success);
    }

    .habit-quick-stats {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      background: var(--bg-color);
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .habit-stat {
      text-align: center;
    }

    .habit-stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--success);
    }

    .habit-stat-label {
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    .habit-list-preview {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .habit-item-preview {
      padding: 8px 12px;
      background: var(--bg-color);
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .habit-checkbox-preview {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--success);
    }

    /* ãƒ†ã‚¹ãƒˆç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .test-section {
      border-color: var(--info);
    }

    .test-countdown-large {
      text-align: center;
      padding: 20px;
      background: var(--bg-color);
      border-radius: 12px;
      margin-bottom: 15px;
    }

    .test-countdown-number {
      font-size: 3rem;
      font-weight: bold;
      color: var(--info);
      margin: 0;
    }

    .test-countdown-label {
      font-size: 0.9rem;
      color: var(--text-dim);
      margin-top: 5px;
    }

    .test-quick-info {
      display: flex;
      gap: 10px;
    }

    .test-info-box {
      flex: 1;
      padding: 10px;
      background: var(--bg-color);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }

    .test-info-box:hover {
      border-color: var(--info);
      transform: scale(1.05);
    }

    .test-info-number {
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--info);
    }

    .test-info-label {
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    /* ãƒ©ãƒ³ãƒ€ãƒ ã‚¿ã‚¹ã‚¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .random-section {
      border-color: var(--purple);
    }

    .task-display-mini {
      background: var(--bg-color);
      padding: 20px;
      border-radius: 12px;
      min-height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 15px;
      word-break: break-word;
    }

    .task-stats-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .task-stat-box {
      flex: 1;
      padding: 8px;
      background: var(--bg-color);
      border-radius: 6px;
      text-align: center;
    }

    .task-stat-number {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--purple);
    }

    .task-stat-label {
      font-size: 0.7rem;
      color: var(--text-dim);
    }

    .btn {
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-success {
      background-color: var(--success);
      color: white;
    }

    .btn-info {
      background-color: var(--info);
      color: white;
    }

    .btn-purple {
      background-color: var(--purple);
      color: white;
    }

    .btn-primary {
      background-color: var(--accent);
      color: white;
    }

    .btn-secondary {
      background-color: transparent;
      color: var(--accent);
      border: 2px solid var(--accent);
    }

    .btn-warning {
      background-color: transparent;
      color: var(--warning);
      border: 2px solid var(--warning);
    }

    .btn-danger {
      background-color: transparent;
      color: var(--danger);
      border: 2px solid var(--danger);
    }

    .btn:hover {
      filter: brightness(1.2);
      transform: scale(1.02);
    }

    .btn-block {
      width: 100%;
      margin-bottom: 8px;
    }

    .btn-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
      overflow-y: auto;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--card-bg);
      padding: 30px;
      padding-top: 60px;
      border-radius: 16px;
      border: 2px solid var(--border);
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-close-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: var(--danger);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: bold;
      cursor: pointer;
      z-index: 1001;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: all 0.2s ease;
    }

    .modal-close-btn:hover {
      filter: brightness(1.2);
      transform: scale(1.05);
    }

    .modal-content h3 {
      margin-top: 0;
      color: var(--accent);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1.5rem;
    }

    .today-badge {
      background: var(--success);
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: normal;
    }

    .habit-progress {
      margin: 20px 0;
      padding: 15px;
      background: var(--bg-color);
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .habit-progress-text {
      font-size: 0.9rem;
      color: var(--text-dim);
      margin-bottom: 10px;
      text-align: center;
    }

    .habit-progress-bar {
      width: 100%;
      height: 10px;
      background: var(--border);
      border-radius: 5px;
      overflow: hidden;
    }

    .habit-progress-fill {
      height: 100%;
      background: var(--success);
      transition: width 0.3s ease;
    }

    .habit-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin: 20px 0;
    }

    .calendar-day {
      aspect-ratio: 1;
      background: var(--bg-color);
      border: 1px solid var(--border);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .calendar-day:hover {
      border-color: var(--success);
    }

    .calendar-day.completed {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }

    .calendar-day.today {
      border: 2px solid var(--accent);
    }

    .calendar-day-number {
      font-size: 1rem;
      font-weight: bold;
    }

    .calendar-day-count {
      font-size: 0.7rem;
      color: var(--text-dim);
    }

    .habit-list {
      list-style: none;
      padding: 0;
      margin: 20px 0;
    }

    .habit-item {
      background: var(--bg-color);
      padding: 14px 16px;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s ease;
    }

    .habit-item:hover {
      border-color: var(--success);
    }

    .habit-item.completed {
      opacity: 0.6;
    }

    .habit-checkbox {
      width: 24px;
      height: 24px;
      min-width: 24px;
      cursor: pointer;
      accent-color: var(--success);
    }

    .habit-text {
      flex-grow: 1;
      font-size: 0.95rem;
    }

    .habit-item.completed .habit-text {
      text-decoration: line-through;
      color: var(--text-dim);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-dim);
      font-size: 0.9rem;
      font-weight: bold;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      background: var(--bg-color);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-main);
      font-size: 1rem;
    }

    .form-group input[type="date"] {
      color-scheme: dark;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-buttons button {
      flex: 1;
    }

    .scroll-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 300px;
      overflow-y: auto;
    }

    .scroll-list li {
      background: var(--bg-color);
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 8px;
      font-size: 0.85rem;
      border: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .task-info {
      flex-grow: 1;
      word-break: break-word;
    }

    .task-buttons {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }

    .scroll-list li button {
      background: var(--accent);
      border: none;
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.7rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .scroll-list li button.delete-btn {
      background: var(--danger);
    }

    .test-item {
      background: var(--bg-color);
      padding: 14px 16px;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .test-item-info {
      flex-grow: 1;
    }

    .test-item-title {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .test-item-date {
      font-size: 0.8rem;
      color: var(--text-dim);
    }

    .test-item button {
      background: var(--danger);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .section-divider {
      margin: 25px 0;
      border-bottom: 1px solid var(--border);
    }

    @media (max-width: 900px) {
      .main-grid {
        grid-template-columns: 1fr;
      }

      .container {
        padding: 15px;
      }

      header h1 {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>å­¦ç¿’ç®¡ç†ãƒ„ãƒ¼ãƒ«</h1>
      <p class="subtitle">ç¿’æ…£ãƒ»ãƒ†ã‚¹ãƒˆãƒ»ã‚¿ã‚¹ã‚¯ã‚’ä¸€å…ƒç®¡ç†</p>
    </header>

    <div class="main-grid">
      <!-- ä»Šæ—¥ã®ç¿’æ…£ -->
      <div class="section-card habit-section">
        <div class="section-header">
          <div class="section-icon">ğŸ“…</div>
          <h2 class="section-title">ä»Šæ—¥ã®ç¿’æ…£</h2>
        </div>
        <div class="section-content">
          <div class="habit-quick-stats">
            <div class="habit-stat">
              <div class="habit-stat-value" id="habitTodayCount">0</div>
              <div class="habit-stat-label">ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯</div>
            </div>
            <div class="habit-stat">
              <div class="habit-stat-value" id="habitCompletedCount">0</div>
              <div class="habit-stat-label">å®Œäº†</div>
            </div>
            <div class="habit-stat">
              <div class="habit-stat-value" id="habitStreakCount">0</div>
              <div class="habit-stat-label">æ—¥é–“ç¶™ç¶š</div>
            </div>
          </div>
          <ul class="habit-list-preview" id="habitListPreview"></ul>
          <button class="btn btn-success btn-block" id="openHabitBtn">è©³ç´°ã‚’è¦‹ã‚‹</button>
        </div>
      </div>

      <!-- ãƒ†ã‚¹ãƒˆç®¡ç† -->
      <div class="section-card test-section">
        <div class="section-header">
          <div class="section-icon">ğŸ“</div>
          <h2 class="section-title">ãƒ†ã‚¹ãƒˆç®¡ç†</h2>
        </div>
        <div class="section-content">
          <div class="test-countdown-large">
            <div class="test-countdown-number" id="testCountdownMain">--</div>
            <div class="test-countdown-label">å®šæœŸãƒ†ã‚¹ãƒˆã¾ã§</div>
          </div>
          <div class="test-quick-info">
            <div class="test-info-box" id="submissionBox">
              <div class="test-info-number" id="submissionCountMain">0</div>
              <div class="test-info-label">æå‡ºç‰©</div>
            </div>
            <div class="test-info-box" id="quizBox">
              <div class="test-info-number" id="quizCountMain">0</div>
              <div class="test-info-label">å°ãƒ†ã‚¹ãƒˆ</div>
            </div>
          </div>
          <button class="btn btn-info btn-block" id="openTestBtn">è¿½åŠ </button>
        </div>
      </div>

      <!-- ãƒ©ãƒ³ãƒ€ãƒ ã‚¿ã‚¹ã‚¯ -->
      <div class="section-card random-section">
        <div class="section-header">
          <div class="section-icon">ğŸ²</div>
          <h2 class="section-title">ãƒ©ãƒ³ãƒ€ãƒ ã‚¿ã‚¹ã‚¯</h2>
        </div>
        <div class="section-content">
          <div class="task-display-mini" id="currentTaskMini">ã‚¿ã‚¹ã‚¯ã‚’å¼•ã„ã¦ãã ã•ã„</div>
          <div class="task-stats-row">
            <div class="task-stat-box">
              <div class="task-stat-number" id="taskCountMain">0</div>
              <div class="task-stat-label">ã‚¿ã‚¹ã‚¯å</div>
            </div>
            <div class="task-stat-box">
              <div class="task-stat-number" id="actionCountMain">0</div>
              <div class="task-stat-label">ä»Šã™ãè¡Œå‹•</div>
            </div>
          </div>
          <div class="btn-group">
            <button class="btn btn-purple" id="drawTaskBtnMain">ã‚¿ã‚¹ã‚¯</button>
            <button class="btn btn-primary" id="drawActionBtnMain">è¡Œå‹•</button>
          </div>
          <button class="btn btn-secondary btn-block" id="openRandomBtn">è©³ç´°ã‚’è¦‹ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç¿’æ…£è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="habitModal" class="modal">
    <button class="modal-close-btn" id="closeHabitBtn">âœ• é–‰ã˜ã‚‹</button>
    <div class="modal-content">
      <h3>
        <span id="habitDayName">ä»Šæ—¥ã®ç¿’æ…£</span>
        <span class="today-badge" id="todayDate"></span>
      </h3>
      
      <div class="habit-progress">
        <div class="habit-progress-text" id="habitProgressText">0 / 0 å®Œäº†</div>
        <div class="habit-progress-bar">
          <div class="habit-progress-fill" id="habitProgressFill" style="width: 0%"></div>
        </div>
      </div>

      <h4 style="color: var(--text-dim); font-size: 1rem;">ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯</h4>
      <ul class="habit-list" id="habitList"></ul>

      <h4 style="color: var(--text-dim); font-size: 1rem; margin-top: 30px;">å®Ÿè¡Œå±¥æ­´ï¼ˆä»Šæœˆï¼‰</h4>
      <div class="habit-calendar" id="habitCalendar"></div>
    </div>
  </div>

  <!-- ãƒ†ã‚¹ãƒˆç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="testModal" class="modal">
    <div class="modal-content">
      <h3>ãƒ†ã‚¹ãƒˆç®¡ç†</h3>
      
      <div class="form-group">
        <label for="testDateInput">å®šæœŸãƒ†ã‚¹ãƒˆæ—¥</label>
        <input type="date" id="testDateInput">
      </div>
      <button class="btn btn-info btn-block" id="saveTestDateBtn">ä¿å­˜</button>

      <div class="section-divider"></div>

      <h4 style="color: var(--text-dim);">æå‡ºç‰©</h4>
      <div class="form-group">
        <input type="text" id="submissionInput" placeholder="æå‡ºç‰©åã‚’å…¥åŠ›">
      </div>
      <button class="btn btn-success btn-block" id="addSubmissionBtn">è¿½åŠ </button>
      <ul class="habit-list" id="submissionList"></ul>

      <div class="section-divider"></div>

      <h4 style="color: var(--text-dim);">å°ãƒ†ã‚¹ãƒˆ</h4>
      <div class="form-group">
        <input type="text" id="quizNameInput" placeholder="ãƒ†ã‚¹ãƒˆå">
      </div>
      <div class="form-group">
        <input type="date" id="quizDateInput">
      </div>
      <button class="btn btn-success btn-block" id="addQuizBtn">è¿½åŠ </button>
      <div id="quizListContainer"></div>

      <div class="modal-buttons">
        <button class="btn btn-primary" id="closeTestBtn">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ãƒ©ãƒ³ãƒ€ãƒ ã‚¿ã‚¹ã‚¯è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="randomModal" class="modal">
    <button class="modal-close-btn" id="closeRandomBtn">âœ• é–‰ã˜ã‚‹</button>
    <div class="modal-content">
      <h3>ãƒ©ãƒ³ãƒ€ãƒ ã‚¿ã‚¹ã‚¯</h3>
      
      <div class="task-display-mini" id="currentTaskFull" style="min-height: 120px; font-size: 1.3rem;">ã‚¿ã‚¹ã‚¯ã‚’å¼•ã„ã¦ãã ã•ã„</div>
      
      <div class="btn-group" style="margin-bottom: 12px;">
        <button class="btn btn-purple" id="drawTaskBtn">ã‚¿ã‚¹ã‚¯ã‚’å¼•ã</button>
        <button class="btn btn-primary" id="drawActionBtn">ä»Šã™ãã§ãã‚‹ã“ã¨</button>
      </div>
      
      <div class="btn-group">
        <button class="btn btn-success" id="execBtn">å®Ÿè¡Œå®Œäº†</button>
        <button class="btn btn-warning" id="skipBtn">ã‚¹ã‚­ãƒƒãƒ—</button>
      </div>

      <div class="section-divider"></div>

      <h4 style="color: var(--text-dim);">ã‚¿ã‚¹ã‚¯å</h4>
      <button class="btn btn-secondary btn-block" id="addTaskBtn">+ è¿½åŠ </button>
      <ul class="scroll-list" id="taskList"></ul>

      <div class="section-divider"></div>

      <h4 style="color: var(--text-dim);">ä»Šã™ãã§ãã‚‹ã“ã¨</h4>
      <button class="btn btn-secondary btn-block" id="addActionBtn">+ è¿½åŠ </button>
      <ul class="scroll-list" id="actionList"></ul>
    </div>
  </div>

  <!-- ã‚¿ã‚¹ã‚¯è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="taskEditModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <h3 id="taskEditTitle">ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </h3>
      <div class="form-group">
        <input type="text" id="taskInput" placeholder="ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›">
      </div>
      <div class="modal-buttons">
        <button class="btn btn-success" id="saveTaskBtn">ä¿å­˜</button>
        <button class="btn btn-danger" id="cancelTaskBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <script>
    console.log("ã‚¹ã‚¯ãƒªãƒ—ãƒˆé–‹å§‹");

    // ç¿’æ…£ãƒ‡ãƒ¼ã‚¿å®šç¾©
    const HABITS = [
      "ãƒã‚¹å¾€è·¯(Leap)",
      "ãƒã‚¹å¾©è·¯(Leap)",
      "æœãƒ†ã‚¹ãƒˆç¢ºèª(ãƒã‚¹)",
      "æœãƒ†ã‚¹ãƒˆå‹‰å¼·",
      "Vintageãƒãƒ¼ãƒˆ",
      "Vintageã®ç¯„å›²ç†è§£"
    ];

    const DAY_HABITS = {
      0: [3],
      1: [2, 3],
      2: [2, 4],
      3: [0, 1, 3],
      4: [2, 3],
      5: [2, 4],
      6: [4, 5]
    };

    const DAY_NAMES = ["æ—¥æ›œæ—¥", "æœˆæ›œæ—¥", "ç«æ›œæ—¥", "æ°´æ›œæ—¥", "æœ¨æ›œæ—¥", "é‡‘æ›œæ—¥", "åœŸæ›œæ—¥"];

    // ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
    let tasks = [];
    let actions = [];
    let currentItem = null;
    let currentType = null;
    let editingIndex = null;
    let editingType = null;
    let habitCompletions = {};
    let habitHistory = {}; // { "2026-01-08": { 0: true, 1: false, ... } }
    let testDate = null;
    let submissions = [];
    let quizzes = [];

    // DOMè¦ç´ 
    const habitModal = document.getElementById("habitModal");
    const testModal = document.getElementById("testModal");
    const submissionModal = document.getElementById("submissionModal");
    const quizModal = document.getElementById("quizModal");
    const randomModal = document.getElementById("randomModal");
    const taskEditModal = document.getElementById("taskEditModal");

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById("openHabitBtn").addEventListener("click", openHabitModal);
    document.getElementById("openTestBtn").addEventListener("click", openTestModal);
    document.getElementById("openRandomBtn").addEventListener("click", openRandomModal);
    
    document.getElementById("drawTaskBtnMain").addEventListener("click", function() {
      drawItemQuick('task');
    });
    
    document.getElementById("drawActionBtnMain").addEventListener("click", function() {
      drawItemQuick('action');
    });
    
    document.getElementById("drawTaskBtn").addEventListener("click", function() {
      drawItem('task');
    });
    
    document.getElementById("drawActionBtn").addEventListener("click", function() {
      drawItem('action');
    });
    
    document.getElementById("execBtn").addEventListener("click", executeItem);
    document.getElementById("skipBtn").addEventListener("click", skipItem);
    document.getElementById("addTaskBtn").addEventListener("click", function() {
      openAddModal('task');
    });
    document.getElementById("addActionBtn").addEventListener("click", function() {
      openAddModal('action');
    });
    
    document.getElementById("saveTaskBtn").addEventListener("click", saveItem);
    document.getElementById("cancelTaskBtn").addEventListener("click", closeTaskEditModal);
    document.getElementById("closeHabitBtn").addEventListener("click", closeHabitModal);
    document.getElementById("closeTestBtn").addEventListener("click", closeTestModal);
    document.getElementById("closeSubmissionBtn").addEventListener("click", closeSubmissionModal);
    document.getElementById("closeQuizBtn").addEventListener("click", closeQuizModal);
    document.getElementById("closeRandomBtn").addEventListener("click", closeRandomModal);
    document.getElementById("saveTestDateBtn").addEventListener("click", saveTestDate);
    document.getElementById("addSubmissionBtn").addEventListener("click", addSubmission);
    document.getElementById("addQuizBtn").addEventListener("click", addQuiz);
    
    document.getElementById("submissionBox").addEventListener("click", openSubmissionModal);
    document.getElementById("quizBox").addEventListener("click", openQuizModal);

    // åˆæœŸåŒ–
    function init() {
      console.log("åˆæœŸåŒ–é–‹å§‹");
      loadData();
      updateMainView();
      checkNewDay();
      console.log("åˆæœŸåŒ–å®Œäº†");
    }

    function checkNewDay() {
      const today = new Date().toDateString();
      const lastDate = localStorage.getItem("lastHabitDate");
      
      if (lastDate !== today) {
        // å‰æ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜
        if (lastDate) {
          const yesterday = new Date(lastDate);
          const dateKey = formatDate(yesterday);
          habitHistory[dateKey] = Object.assign({}, habitCompletions);
        }
        
        habitCompletions = {};
        localStorage.setItem("lastHabitDate", today);
        saveData();
      }
    }

    function formatDate(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function saveData() {
      const data = {
        tasks: tasks,
        actions: actions,
        habitCompletions: habitCompletions,
        habitHistory: habitHistory,
        testDate: testDate,
        submissions: submissions,
        quizzes: quizzes
      };
      localStorage.setItem("taskManagerData", JSON.stringify(data));
      console.log("ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†", data);
    }

    function loadData() {
      const saved = localStorage.getItem("taskManagerData");
      if (saved) {
        const data = JSON.parse(saved);
        tasks = data.tasks || [];
        actions = data.actions || [];
        habitCompletions = data.habitCompletions || {};
        habitHistory = data.habitHistory || {};
        testDate = data.testDate || null;
        submissions = data.submissions || [];
        quizzes = data.quizzes || [];
      } else {
        tasks = [
          { text: "å›½èª", pending: 0 },
          { text: "æ•°å­¦", pending: 0 },
          { text: "è‹±èª", pending: 0 },
          { text: "åŒ–å­¦", pending: 0 },
          { text: "æ­´å²", pending: 0 },
          { text: "åœ°ç†", pending: 0 },
          { text: "æƒé™¤", pending: 0 }
        ];
        actions = [
          { text: "å¤æ–‡å˜èª", pending: 0 },
          { text: "ä½“ç³»æ¼¢æ–‡", pending: 0 },
          { text: "æ•°å­¦æ•™ç§‘æ›¸ç¢ºèª", pending: 0 },
          { text: "Vintageãƒãƒ¼ãƒˆ", pending: 0 },
          { text: "Leap", pending: 0 },
          { text: "åŒ–å­¦ã‚»ãƒŸãƒŠãƒ¼ç¢ºèª", pending: 0 },
          { text: "NewCompus", pending: 0 },
          { text: "æ­´å²ãƒãƒ¼ãƒˆ", pending: 0 },
          { text: "æœºã‚’ãã‚Œã„ã«ã™ã‚‹", pending: 0 }
        ];
      }
      console.log("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†");
    }

    function updateMainView() {
      // ç¿’æ…£ã‚»ã‚¯ã‚·ãƒ§ãƒ³
      const today = new Date();
      const dayOfWeek = today.getDay();
      const todayHabits = DAY_HABITS[dayOfWeek] || [];
      
      let completedHabits = 0;
      todayHabits.forEach(index => {
        if (habitCompletions[index]) completedHabits++;
      });
      
      document.getElementById("habitTodayCount").textContent = todayHabits.length;
      document.getElementById("habitCompletedCount").textContent = completedHabits;
      
      // ç¶™ç¶šæ—¥æ•°è¨ˆç®—
      let streak = 0;
      const checkDate = new Date();
      checkDate.setDate(checkDate.getDate() - 1);
      
      while (true) {
        const dateKey = formatDate(checkDate);
        const dayData = habitHistory[dateKey];
        
        if (!dayData) break;
        
        const dayOfWeek = checkDate.getDay();
        const dayHabits = DAY_HABITS[dayOfWeek] || [];
        
        if (dayHabits.length === 0) {
          checkDate.setDate(checkDate.getDate() - 1);
          continue;
        }
        
        const allCompleted = dayHabits.every(index => dayData[index]);
        if (!allCompleted) break;
        
        streak++;
        checkDate.setDate(checkDate.getDate() - 1);
      }
      
      document.getElementById("habitStreakCount").textContent = streak;
      
      // ç¿’æ…£ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆ
      const habitListPreview = document.getElementById("habitListPreview");
      habitListPreview.innerHTML = "";
      
      todayHabits.slice(0, 3).forEach(habitIndex => {
        const li = document.createElement("li");
        li.className = "habit-item-preview";
        
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "habit-checkbox-preview";
        checkbox.checked = habitCompletions[habitIndex] || false;
        checkbox.addEventListener("change", function() {
          habitCompletions[habitIndex] = this.checked;
          saveData();
          updateMainView();
        });
        
        const text = document.createElement("span");
        text.textContent = HABITS[habitIndex];
        if (checkbox.checked) {
          text.style.textDecoration = "line-through";
          text.style.color = "var(--text-dim)";
        }
        
        li.appendChild(checkbox);
        li.appendChild(text);
        habitListPreview.appendChild(li);
      });
      
      if (todayHabits.length > 3) {
        const li = document.createElement("li");
        li.className = "habit-item-preview";
        li.style.justifyContent = "center";
        li.style.color = "var(--accent)";
        li.textContent = `ä»– ${todayHabits.length - 3}ä»¶...`;
        habitListPreview.appendChild(li);
      }
      
      if (todayHabits.length === 0) {
        const li = document.createElement("li");
        li.className = "habit-item-preview";
        li.style.justifyContent = "center";
        li.style.color = "var(--text-dim)";
        li.textContent = "ä»Šæ—¥ã®ç¿’æ…£ã¯ã‚ã‚Šã¾ã›ã‚“";
        habitListPreview.appendChild(li);
      }
      
      // ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
      updateTestCountdown();
      document.getElementById("submissionCountMain").textContent = submissions.length;
      document.getElementById("quizCountMain").textContent = quizzes.length;
      
      // ãƒ©ãƒ³ãƒ€ãƒ ã‚¿ã‚¹ã‚¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³
      document.getElementById("taskCountMain").textContent = tasks.length;
      document.getElementById("actionCountMain").textContent = actions.length;
    }

    function updateTestCountdown() {
      if (!testDate) {
        document.getElementById("testCountdownMain").textContent = "--";
        return;
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const test = new Date(testDate);
      test.setHours(0, 0, 0, 0);
      
      const diffTime = test - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      if (diffDays < 0) {
        document.getElementById("testCountdownMain").textContent = "çµ‚äº†";
      } else if (diffDays === 0) {
        document.getElementById("testCountdownMain").textContent = "ä»Šæ—¥";
      } else {
        document.getElementById("testCountdownMain").textContent = diffDays;
      }
    }

    // ç¿’æ…£ãƒ¢ãƒ¼ãƒ€ãƒ«
    function openHabitModal() {
      const today = new Date();
      const dayOfWeek = today.getDay();
      const todayHabits = DAY_HABITS[dayOfWeek] || [];
      
      const month = today.getMonth() + 1;
      const date = today.getDate();
      document.getElementById("todayDate").textContent = `${month}/${date}`;
      document.getElementById("habitDayName").textContent = `${DAY_NAMES[dayOfWeek]}ã®ç¿’æ…£`;
      
      // é€²æ—è¡¨ç¤º
      let completedHabits = 0;
      todayHabits.forEach(index => {
        if (habitCompletions[index]) completedHabits++;
      });
      
      const progress = todayHabits.length > 0 ? Math.round((completedHabits / todayHabits.length) * 100) : 0;
      document.getElementById("habitProgressText").textContent = `${completedHabits} / ${todayHabits.length} å®Œäº†`;
      document.getElementById("habitProgressFill").style.width = `${progress}%`;
      
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º
      renderHabitCalendar();
      
      // ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ
      const habitList = document.getElementById("habitList");
      habitList.innerHTML = "";
      
      if (todayHabits.length === 0) {
        const li = document.createElement("li");
        li.className = "habit-item";
        li.style.justifyContent = "center";
        li.style.color = "var(--text-dim)";
        li.textContent = "ä»Šæ—¥ã®ç¿’æ…£ã¯ã‚ã‚Šã¾ã›ã‚“";
        habitList.appendChild(li);
      } else {
        todayHabits.forEach(habitIndex => {
          const habitText = HABITS[habitIndex];
          const isCompleted = habitCompletions[habitIndex] || false;
          
          const li = document.createElement("li");
          li.className = "habit-item";
          if (isCompleted) li.classList.add("completed");
          
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.className = "habit-checkbox";
          checkbox.checked = isCompleted;
          checkbox.setAttribute("data-habit-index", habitIndex);
          checkbox.addEventListener("change", toggleHabit);
          
          const text = document.createElement("span");
          text.className = "habit-text";
          text.textContent = habitText;
          
          li.appendChild(checkbox);
          li.appendChild(text);
          habitList.appendChild(li);
        });
      }
      
      habitModal.classList.add("active");
    }

    function renderHabitCalendar() {
      const calendar = document.getElementById("habitCalendar");
      calendar.innerHTML = "";
      
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateKey = formatDate(date);
        const dayOfWeek = date.getDay();
        const dayHabits = DAY_HABITS[dayOfWeek] || [];
        
        const div = document.createElement("div");
        div.className = "calendar-day";
        
        const isToday = day === today.getDate();
        if (isToday) div.classList.add("today");
        
        const dayNum = document.createElement("div");
        dayNum.className = "calendar-day-number";
        dayNum.textContent = day;
        
        const dayData = habitHistory[dateKey] || (isToday ? habitCompletions : null);
        
        if (dayData && dayHabits.length > 0) {
          const completed = dayHabits.filter(index => dayData[index]).length;
          
          if (completed === dayHabits.length) {
            div.classList.add("completed");
          }
          
          const count = document.createElement("div");
          count.className = "calendar-day-count";
          count.textContent = `${completed}/${dayHabits.length}`;
          
          div.appendChild(dayNum);
          div.appendChild(count);
        } else {
          div.appendChild(dayNum);
        }
        
        calendar.appendChild(div);
      }
    }

    function toggleHabit(e) {
      const habitIndex = parseInt(e.target.getAttribute("data-habit-index"));
      habitCompletions[habitIndex] = !habitCompletions[habitIndex];
      saveData();
      
      const today = new Date();
      const dayOfWeek = today.getDay();
      const todayHabits = DAY_HABITS[dayOfWeek] || [];
      
      let completedHabits = 0;
      todayHabits.forEach(index => {
        if (habitCompletions[index]) completedHabits++;
      });
      
      const progress = Math.round((completedHabits / todayHabits.length) * 100);
      document.getElementById("habitProgressText").textContent = `${completedHabits} / ${todayHabits.length} å®Œäº†`;
      document.getElementById("habitProgressFill").style.width = `${progress}%`;
      
      if (e.target.checked) {
        e.target.parentElement.classList.add("completed");
      } else {
        e.target.parentElement.classList.remove("completed");
      }
      
      renderHabitCalendar();
      updateMainView();
    }

    function closeHabitModal() {
      habitModal.classList.remove("active");
    }

    // ãƒ†ã‚¹ãƒˆç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«
    function openTestModal() {
      if (testDate) {
        document.getElementById("testDateInput").value = testDate;
      }
      testModal.classList.add("active");
    }

    function closeTestModal() {
      testModal.classList.remove("active");
    }

    function openSubmissionModal() {
      renderSubmissionsDetail();
      submissionModal.classList.add("active");
    }

    function closeSubmissionModal() {
      submissionModal.classList.remove("active");
    }

    function openQuizModal() {
      renderQuizzesDetail();
      quizModal.classList.add("active");
    }

    function closeQuizModal() {
      quizModal.classList.remove("active");
    }

    function saveTestDate() {
      testDate = document.getElementById("testDateInput").value;
      saveData();
      updateMainView();
      alert("å®šæœŸãƒ†ã‚¹ãƒˆæ—¥ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    }

    function addSubmission() {
      const text = document.getElementById("submissionInput").value.trim();
      
      if (!text) {
        alert("æå‡ºç‰©åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      submissions.push({ text: text, completed: false });
      document.getElementById("submissionInput").value = "";
      saveData();
      updateMainView();
      alert("æå‡ºç‰©ã‚’è¿½åŠ ã—ã¾ã—ãŸ");
    }

    function renderSubmissionsDetail() {
      const submissionList = document.getElementById("submissionListDetail");
      submissionList.innerHTML = "";
      
      if (submissions.length === 0) {
        const li = document.createElement("li");
        li.className = "habit-item";
        li.style.justifyContent = "center";
        li.style.color = "var(--text-dim)";
        li.textContent = "æå‡ºç‰©ã¯ã‚ã‚Šã¾ã›ã‚“";
        submissionList.appendChild(li);
        return;
      }

      for (let i = 0; i < submissions.length; i++) {
        const sub = submissions[i];
        const li = document.createElement("li");
        li.className = "habit-item";
        if (sub.completed) li.classList.add("completed");
        
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "habit-checkbox";
        checkbox.checked = sub.completed;
        checkbox.addEventListener("change", function() {
          submissions[i].completed = !submissions[i].completed;
          saveData();
          renderSubmissionsDetail();
          updateMainView();
        });
        
        const text = document.createElement("span");
        text.className = "habit-text";
        text.textContent = sub.text;
        
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "å‰Šé™¤";
        deleteBtn.style.background = "var(--danger)";
        deleteBtn.style.border = "none";
        deleteBtn.style.color = "white";
        deleteBtn.style.padding = "4px 10px";
        deleteBtn.style.borderRadius = "4px";
        deleteBtn.style.fontSize = "0.75rem";
        deleteBtn.style.cursor = "pointer";
        deleteBtn.style.marginLeft = "auto";
        deleteBtn.addEventListener("click", function() {
          submissions.splice(i, 1);
          saveData();
          renderSubmissionsDetail();
          updateMainView();
        });
        
        li.appendChild(checkbox);
        li.appendChild(text);
        li.appendChild(deleteBtn);
        submissionList.appendChild(li);
      }
    }

    function addQuiz() {
      const name = document.getElementById("quizNameInput").value.trim();
      const date = document.getElementById("quizDateInput").value;
      
      if (!name || !date) {
        alert("ãƒ†ã‚¹ãƒˆåã¨å®Ÿæ–½æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      quizzes.push({ name: name, date: date });
      quizzes.sort((a, b) => new Date(a.date) - new Date(b.date));
      
      document.getElementById("quizNameInput").value = "";
      document.getElementById("quizDateInput").value = "";
      saveData();
      updateMainView();
      alert("å°ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ");
    }

    function renderQuizzesDetail() {
      const quizListContainer = document.getElementById("quizListDetail");
      quizListContainer.innerHTML = "";
      
      if (quizzes.length === 0) {
        const div = document.createElement("div");
        div.className = "test-item";
        div.style.justifyContent = "center";
        div.style.color = "var(--text-dim)";
        div.textContent = "å°ãƒ†ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“";
        quizListContainer.appendChild(div);
        return;
      }

      for (let i = 0; i < quizzes.length; i++) {
        const quiz = quizzes[i];
        const div = document.createElement("div");
        div.className = "test-item";
        
        const info = document.createElement("div");
        info.className = "test-item-info";
        
        const title = document.createElement("div");
        title.className = "test-item-title";
        title.textContent = quiz.name;
        
        const dateText = document.createElement("div");
        dateText.className = "test-item-date";
        const quizDate = new Date(quiz.date);
        dateText.textContent = `${quizDate.getMonth() + 1}/${quizDate.getDate()}`;
        
        info.appendChild(title);
        info.appendChild(dateText);
        
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "å‰Šé™¤";
        deleteBtn.addEventListener("click", function() {
          quizzes.splice(i, 1);
          saveData();
          renderQuizzesDetail();
          updateMainView();
        });
        
        div.appendChild(info);
        div.appendChild(deleteBtn);
        quizListContainer.appendChild(div);
      }
    }

    // ãƒ©ãƒ³ãƒ€ãƒ ã‚¿ã‚¹ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«
    function openRandomModal() {
      renderLists();
      randomModal.classList.add("active");
    }

    function closeRandomModal() {
      randomModal.classList.remove("active");
    }

    function renderLists() {
      // ã‚¿ã‚¹ã‚¯ä¸€è¦§
      const taskList = document.getElementById("taskList");
      taskList.innerHTML = "";
      
      for (let i = 0; i < tasks.length; i++) {
        const t = tasks[i];
        const li = document.createElement("li");
        
        const info = document.createElement("div");
        info.className = "task-info";
        info.textContent = t.text;
        
        const buttons = document.createElement("div");
        buttons.className = "task-buttons";
        
        const editBtn = document.createElement("button");
        editBtn.textContent = "ç·¨é›†";
        editBtn.setAttribute("data-type", "task");
        editBtn.setAttribute("data-index", i);
        editBtn.addEventListener("click", handleEdit);
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.textContent = "å‰Šé™¤";
        deleteBtn.setAttribute("data-type", "task");
        deleteBtn.setAttribute("data-index", i);
        deleteBtn.addEventListener("click", handleDelete);
        
        buttons.appendChild(editBtn);
        buttons.appendChild(deleteBtn);
        
        li.appendChild(info);
        li.appendChild(buttons);
        taskList.appendChild(li);
      }

      // ä»Šã™ãã§ãã‚‹ã“ã¨ä¸€è¦§
      const actionList = document.getElementById("actionList");
      actionList.innerHTML = "";
      
      for (let i = 0; i < actions.length; i++) {
        const a = actions[i];
        const li = document.createElement("li");
        
        const info = document.createElement("div");
        info.className = "task-info";
        info.textContent = a.text;
        
        const buttons = document.createElement("div");
        buttons.className = "task-buttons";
        
        const editBtn = document.createElement("button");
        editBtn.textContent = "ç·¨é›†";
        editBtn.setAttribute("data-type", "action");
        editBtn.setAttribute("data-index", i);
        editBtn.addEventListener("click", handleEdit);
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.textContent = "å‰Šé™¤";
        deleteBtn.setAttribute("data-type", "action");
        deleteBtn.setAttribute("data-index", i);
        deleteBtn.addEventListener("click", handleDelete);
        
        buttons.appendChild(editBtn);
        buttons.appendChild(deleteBtn);
        
        li.appendChild(info);
        li.appendChild(buttons);
        actionList.appendChild(li);
      }
    }

    function handleEdit(e) {
      const type = e.target.getAttribute("data-type");
      const index = parseInt(e.target.getAttribute("data-index"));
      openEditModal(type, index);
    }

    function handleDelete(e) {
      const type = e.target.getAttribute("data-type");
      const index = parseInt(e.target.getAttribute("data-index"));
      deleteItem(type, index);
    }

    function deleteItem(type, index) {
      if (!confirm("ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        return;
      }
      
      if (type === 'task') {
        tasks.splice(index, 1);
      } else {
        actions.splice(index, 1);
      }
      
      if (currentItem) {
        currentItem = null;
        currentType = null;
        document.getElementById("currentTaskFull").textContent = "å‰Šé™¤ã•ã‚Œã¾ã—ãŸ";
        document.getElementById("currentTaskMini").textContent = "å‰Šé™¤ã•ã‚Œã¾ã—ãŸ";
      }
      
      saveData();
      renderLists();
      updateMainView();
    }

    function drawItemQuick(type) {
      const list = type === 'task' ? tasks : actions;
      
      if (list.length === 0) {
        document.getElementById("currentTaskMini").textContent = type === 'task' ? "ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“" : "è¡Œå‹•ãŒã‚ã‚Šã¾ã›ã‚“";
        return;
      }

      const weights = list.map(t => Math.pow(2, t.pending));
      const totalWeight = weights.reduce((a, b) => a + b, 0);
      let random = Math.random() * totalWeight;
      
      for (let i = 0; i < list.length; i++) {
        random -= weights[i];
        if (random <= 0) {
          currentItem = list[i];
          currentType = type;
          break;
        }
      }

      document.getElementById("currentTaskMini").textContent = currentItem.text;
      document.getElementById("currentTaskFull").textContent = currentItem.text;
    }

    function drawItem(type) {
      const list = type === 'task' ? tasks : actions;
      
      if (list.length === 0) {
        document.getElementById("currentTaskFull").textContent = type === 'task' ? "ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“" : "è¡Œå‹•ãŒã‚ã‚Šã¾ã›ã‚“";
        return;
      }

      const weights = list.map(t => Math.pow(2, t.pending));
      const totalWeight = weights.reduce((a, b) => a + b, 0);
      let random = Math.random() * totalWeight;
      
      for (let i = 0; i < list.length; i++) {
        random -= weights[i];
        if (random <= 0) {
          currentItem = list[i];
          currentType = type;
          break;
        }
      }

      document.getElementById("currentTaskFull").textContent = currentItem.text;
      document.getElementById("currentTaskMini").textContent = currentItem.text;
    }

    function executeItem() {
      if (!currentItem || !currentType) return;
      
      if (currentType === 'task') {
        tasks = tasks.filter(t => t !== currentItem);
      } else {
        actions = actions.filter(a => a !== currentItem);
      }
      
      currentItem = null;
      currentType = null;
      document.getElementById("currentTaskFull").textContent = "å®Œäº†ã—ã¾ã—ãŸï¼æ¬¡ã‚’å¼•ã„ã¦ãã ã•ã„";
      document.getElementById("currentTaskMini").textContent = "å®Œäº†ï¼";
      
      saveData();
      renderLists();
      updateMainView();
    }

    function skipItem() {
      if (!currentItem || !currentType) return;
      
      document.getElementById("currentTaskFull").textContent = "ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚æ¬¡ã‚’å¼•ã„ã¦ãã ã•ã„";
      document.getElementById("currentTaskMini").textContent = "ã‚¹ã‚­ãƒƒãƒ—";
      
      currentItem = null;
      currentType = null;
    }

    function openAddModal(type) {
      editingIndex = null;
      editingType = type;
      document.getElementById("taskEditTitle").textContent = type === 'task' ? "ã‚¿ã‚¹ã‚¯åã‚’è¿½åŠ " : "ä»Šã™ãã§ãã‚‹ã“ã¨ã‚’è¿½åŠ ";
      document.getElementById("taskInput").value = "";
      taskEditModal.classList.add("active");
      document.getElementById("taskInput").focus();
    }

    function openEditModal(type, index) {
      editingIndex = index;
      editingType = type;
      document.getElementById("taskEditTitle").textContent = type === 'task' ? "ã‚¿ã‚¹ã‚¯åã‚’ç·¨é›†" : "ä»Šã™ãã§ãã‚‹ã“ã¨ã‚’ç·¨é›†";
      document.getElementById("taskInput").value = type === 'task' ? tasks[index].text : actions[index].text;
      taskEditModal.classList.add("active");
      document.getElementById("taskInput").focus();
    }

    function closeTaskEditModal() {
      taskEditModal.classList.remove("active");
      document.getElementById("taskInput").value = "";
      editingIndex = null;
      editingType = null;
    }

    function saveItem() {
      const text = document.getElementById("taskInput").value.trim();
      
      if (!text) {
        alert("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      if (editingIndex !== null) {
        if (editingType === 'task') {
          tasks[editingIndex].text = text;
        } else {
          actions[editingIndex].text = text;
        }
      } else {
        if (editingType === 'task') {
          tasks.push({ text: text, pending: 0 });
        } else {
          actions.push({ text: text, pending: 0 });
        }
      }

      saveData();
      renderLists();
      updateMainView();
      closeTaskEditModal();
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    habitModal.addEventListener("click", function(e) {
      if (e.target === habitModal) {
        closeHabitModal();
      }
    });

    testModal.addEventListener("click", function(e) {
      if (e.target === testModal) {
        closeTestModal();
      }
    });

    submissionModal.addEventListener("click", function(e) {
      if (e.target === submissionModal) {
        closeSubmissionModal();
      }
    });

    quizModal.addEventListener("click", function(e) {
      if (e.target === quizModal) {
        closeQuizModal();
      }
    });

    randomModal.addEventListener("click", function(e) {
      if (e.target === randomModal) {
        closeRandomModal();
      }
    });

    taskEditModal.addEventListener("click", function(e) {
      if (e.target === taskEditModal) {
        closeTaskEditModal();
      }
    });

    // Enterã‚­ãƒ¼
    document.getElementById("taskInput").addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        saveItem();
      }
    });

    document.getElementById("submissionInput").addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        addSubmission();
      }
    });

    init();
  </script>
</body>
</html>
